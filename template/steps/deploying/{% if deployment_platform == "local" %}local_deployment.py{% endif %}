# {% include 'template/license_header' %}

from typing import Optional, List
import os
import subprocess

from zenml import step
from zenml.client import Client
from zenml.logger import get_logger

# Initialize logger
logger = get_logger(__name__)


@step()
def deploy_locally(
    model_name_or_path: str,
    tokenizer_name_or_path: str,
    labels: List[str],
    title: Optional[str] = "ZenML",
    description: Optional[str] = "ZenML NLP Use-Case",
    interpretation: Optional[str] = "default",
    example: Optional[str] = "This use-case is awesome!",
):
    """
    
    Args:
        mlfow_model_name: The name of the model in MLFlow.
        stage: The stage of the model in MLFlow.

    Returns:
        The trained model and tokenizer.
    """
    ### ADD YOUR OWN CODE HERE - THIS IS JUST AN EXAMPLE ###
    def start_gradio_app(command: list[str]) -> int:
        """
        Start the Gradio app in a separate process.

        Args:
            command: The command to start the Gradio app.
        
        Returns:
            The process ID of the Gradio app.
        """
        # Start the Gradio app in a separate process
        process = subprocess.Popen(command)

        # Print the process ID
        logger.info(f"Started Gradio app with process ID: {process.pid}")

        return process.pid

    lables = ",".join(labels)
    # Construct the path to the app.py file
    app_path = str(os.path.join(Client().root, "gradio", "app.py"))
    command = ["python", app_path, "--tokenizer_name_or_path", tokenizer_path, "--model_name_or_path", model_path, 
        "--labels", lables, "--title", title, "--description", description, 
       "--interpretation", interpretation, "--examples", example]
    logger.info(f"Command: {command}")
    # Call the function to launch the script
    pid = start_gradio_app(command)
    logger.info(f"Process ID: {pid}")
    logger.info(f"To kill the process, run: kill -9 {pid}")
    ### YOUR CODE ENDS HERE ###
